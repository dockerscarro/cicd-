name: CI/CD Pipeline (QA - Full Stack + HubSpot ETL)

on:
  push:
    branches:
      - xyz

jobs:

  # =====================================================
  # 1️⃣ CI - NODE APP
  # =====================================================
  node-ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit


  # =====================================================
  # 2️⃣ DOCKER TEST - NODE APP
  # =====================================================
  node-docker-test:
    needs: node-ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (Node)
        run: docker build -t dgm-remapp:test .

      - name: Run container for smoke test
        run: |
          docker run -d --name dgm-remapp-test -p 3002:3000 dgm-remapp:test
          sleep 10
          if [ "$(docker inspect -f '{{.State.Running}}' dgm-remapp-test)" != "true" ]; then
            echo "❌ Node container crashed"
            docker logs dgm-remapp-test
            exit 1
          fi
          echo "✅ Node container running"

      - name: HTTP smoke test
        run: curl -f http://localhost:3002

      - name: Print container logs
        if: always()
        run: docker logs dgm-remapp-test

      - name: Cleanup
        if: always()
        run: |
          docker stop dgm-remapp-test
          docker rm dgm-remapp-test


  # =====================================================
  # 3️⃣ CI - PYTHON HUBSPOT ETL
  # =====================================================
  python-ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run lint
        run: |
          pip install flake8
          flake8 .


  # =====================================================
  # 4️⃣ DOCKER BUILD - HUBSPOT ETL
  # =====================================================
  python-docker-build:
    needs: python-ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ETL Docker image
        run: docker build -t hubspot-sync:test .


  # =====================================================
  # 5️⃣ DEPLOY BOTH TO SERVER
  # =====================================================
  deploy-to-server:
    needs:
      - node-docker-test
      - python-docker-build
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
          "echo '✅ Connected to server successfully!'"

      - name: Deploy Applications
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << EOF
          set -e

          ##################################################
          # NODE APP DEPLOY
          ##################################################
          NODE_DIR=~/dgm-remapp
          NODE_CONTAINER=dgm-remapp
          NODE_REPO=https://github.com/dockerscarro/cicd-.git
          BRANCH=qa
          PAT_TOKEN=${{ secrets.PAT_TOKEN }}

          if [ ! -d "\$NODE_DIR" ]; then
              git clone -b \$BRANCH https://\$PAT_TOKEN@github.com/dockerscarro/cicd-.git \$NODE_DIR
          else
              cd \$NODE_DIR
              git fetch --all
              git reset --hard origin/\$BRANCH
          fi

          cd \$NODE_DIR
          docker build -t \$NODE_CONTAINER:qa .

          if [ "\$(docker ps -aq -f name=\$NODE_CONTAINER)" ]; then
              docker stop \$NODE_CONTAINER || true
              docker rm \$NODE_CONTAINER || true
          fi

          docker run -d -p 3002:3000 --name \$NODE_CONTAINER \$NODE_CONTAINER:qa

          sleep 5
          if [ "\$(docker inspect -f '{{.State.Running}}' \$NODE_CONTAINER)" != "true" ]; then
              docker logs \$NODE_CONTAINER
              exit 1
          fi

          echo "✅ Node app deployed successfully"


          ##################################################
          # HUBSPOT ETL DEPLOY
          ##################################################
          ETL_DIR=~/hubspot-sync
          ETL_REPO=https://github.com/dockerscarro/postgres.git

          if [ ! -d "\$ETL_DIR" ]; then
              git clone -b \$BRANCH https://\$PAT_TOKEN@github.com/dockerscarro/postgres.git \$ETL_DIR
          else
              cd \$ETL_DIR
              git fetch --all
              git reset --hard origin/\$BRANCH
          fi

          cd \$ETL_DIR
          docker build -t hubspot-sync:latest .

          docker network create hubspot-net || true
          docker network connect hubspot-net postgres-hubspot || true

          if [ "\$(docker ps -q -f name=postgres-hubspot)" == "" ]; then
              echo "❌ Postgres container not running"
              exit 1
          fi

          docker run --rm \
            --name hubspot-sync \
            --network hubspot-net \
            -e HUBSPOT_API_KEY="${{ secrets.HUBSPOT_API_KEY }}" \
            -e POSTGRES_HOST="postgres-hubspot" \
            -e POSTGRES_PORT=5432 \
            -e POSTGRES_DB="hubspot_db" \
            -e POSTGRES_USER="postgres" \
            -e POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
            hubspot-sync:latest

          echo "✅ HubSpot ETL executed successfully"

          EOF
