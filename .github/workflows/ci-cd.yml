name: CI/CD Pipeline (ABC)

on:
  push:
    branches:
      - abc

jobs:

  # ===========================================
  # 1️⃣ Node CI
  # ===========================================
  ci-node:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npx tsc --noEmit


  # ===========================================
  # 2️⃣ Python CI
  # ===========================================
  ci-python:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: etl

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Lint
        run: |
          pip install flake8
          flake8 .


  # ===========================================
  # 3️⃣ Deploy to Server
  # ===========================================
  deploy:
    needs: [ci-node, ci-python]
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Deploy to Server
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<EOF
          set -e

          APP_DIR=~/project-root
          BRANCH=abc
          REPO=https://${{ secrets.PAT_TOKEN }}@github.com/dockerscarro/YOUR_REPO.git

          # Clone or update repository
          if [ ! -d "\$APP_DIR" ]; then
              git clone -b \$BRANCH \$REPO \$APP_DIR
          else
              cd \$APP_DIR
              git fetch origin
              git reset --hard origin/\$BRANCH
          fi

          cd \$APP_DIR

          # Create .env file
          echo "HUBSPOT_API_KEY=${{ secrets.HUBSPOT_API_KEY }}" > .env
          echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env

          # Ensure external network exists
          docker network create hubspot-net || true

          # Fully clean previous containers
          docker compose down --remove-orphans

          # Build and start fresh
          docker compose up -d --build

          # Run ETL once
          docker compose run --rm hubspot_sync

          echo "✅ Deployment completed successfully"

          EOF
