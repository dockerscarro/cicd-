name: CI/CD Pipeline (QA)

on:
  push:
    branches:
      - abc

jobs:

  # ==========================================
  # 1️⃣ Node CI
  # ==========================================
  ci-node:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npx tsc --noEmit


  # ==========================================
  # 2️⃣ Python CI
  # ==========================================
  ci-python:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: etl

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Lint
        run: |
          pip install flake8
          flake8 .


  # ==========================================
  # 3️⃣ Deploy
  # ==========================================
  deploy:
    needs: [ci-node, ci-python]
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Deploy to Server
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_PORT }} \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} <<EOF
          set -e

          APP_DIR=~/project-root
          BRANCH=qa
          REPO=https://${{ secrets.PAT_TOKEN }}@github.com/dockerscarro/YOUR_REPO.git

          if [ ! -d "\$APP_DIR" ]; then
              git clone -b \$BRANCH \$REPO \$APP_DIR
          else
              cd \$APP_DIR
              git fetch --all
              git reset --hard origin/\$BRANCH
          fi

          cd \$APP_DIR

          # Create .env dynamically from GitHub Secrets
          cat <<EOT > .env
          HUBSPOT_API_KEY=${{ secrets.HUBSPOT_API_KEY }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          EOT

          # Ensure network exists
          docker network create hubspot-net || true

          # Build images
          docker compose build

          # Start frontend
          docker compose up -d app

          echo "✅ Frontend deployed"

          # Run ETL once
          docker compose run --rm hubspot_sync

          echo "✅ ETL executed successfully"

          EOF
